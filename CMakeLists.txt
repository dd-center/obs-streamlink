cmake_minimum_required(VERSION 3.5)
set(CMAKE_CXX_STANDARD 20)
project(obs-streamlink)

set(CMAKE_MODULE_PATH "${PROJECT_SOURCE_DIR}")

find_package(FFmpeg REQUIRED
    COMPONENTS avcodec avfilter avdevice avutil swscale avformat swresample)
find_package(Python3 3.8 EXACT REQUIRED COMPONENTS Interpreter Development)
find_library(Python3Gen NAME "python38.lib" PATHS "${Python3_LIBRARY_DIRS}" NO_DEFAULT_PATH)
#find_library(Python3Gen_Debug NAME "python38_d.lib" PATHS "${Python3_LIBRARY_DIRS}" NO_DEFAULT_PATH)

set(CMAKE_INCLUDE_CURRENT_DIR ON)
set(CMAKE_AUTOMOC ON)

add_library(obs-streamlink MODULE
    obs-streamlink.cpp
    streamlink-delayload.cpp
    streamlink-source.cpp
    media-playback/decode.cpp
    media-playback/media.cpp
    python-streamlink.cpp
    )
target_link_libraries(obs-streamlink PRIVATE
    "${LIBOBS_LIB}"
    "${W32_PTHREADS_LIB}"
    "${OBS_FRONTEND_LIB}"
    ${FFMPEG_LIBRARIES}
    delayimp)
if (CMAKE_BUILD_TYPE STREQUAL "Debug")
    target_link_libraries(obs-streamlink PRIVATE "${Python3Gen}")
else()
    target_link_libraries(obs-streamlink PRIVATE "${Python3Gen}")
endif()
target_include_directories(obs-streamlink PRIVATE
    ${FFMPEG_INCLUDE_DIRS}
    "${W32_PTHREADS_INCLUDES}"
    "${LIBOBS_INCLUDE_DIR}"
    "${OBS_FRONTEND_INCLUDE_DIR}"
    "${Python3_INCLUDE_DIRS}"
    "deps/"
)
set(RELEASE_DIR "${PROJECT_SOURCE_DIR}/release")
target_link_options(obs-streamlink PUBLIC
        "/NODEFAULTLIB:python38_d.lib"
        "/NODEFAULTLIB:python3_d.lib"
        "/NODEFAULTLIB:python38.lib"
        "/NODEFAULTLIB:python3.lib"
        "/delayload:python38.dll"
        "/delayload:avcodec-59.dll"
        "/delayload:avdevice-59.dll"
        "/delayload:avfilter-8.dll"
        "/delayload:avformat-59.dll"
        "/delayload:avutil-57.dll"
        "/delayload:swresample-4.dll"
        "/delayload:swscale-6.dll"
)

add_custom_command(TARGET obs-streamlink POST_BUILD
        # Copy to obs-studio dev environment for immediate testing
                # »¹ÊÇÅ×ÍßÐ»¶û¶¥
        COMMAND powershell -Command "if ($<CONFIG:Release> -eq 1 ) {robocopy ${PROJECT_SOURCE_DIR}/out/build/x64-Release ${RELEASE_DIR}/obs-plugins ${OBS_ARCH_NAME};robocopy ${PROJECT_SOURCE_DIR}/data ${RELEASE_DIR}/data/obs-plugins/obs-streamlink /E;}"

        COMMAND powershell -Command "if ($<CONFIG:Debug> -eq 1 ) { robocopy ${PROJECT_SOURCE_DIR}/out/build/x64-Debug ${OBS_RUNDIR}/obs-plugins/64bit ${OBS_ARCH_NAME};robocopy ${PROJECT_SOURCE_DIR}/data ${OBS_RUNDIR}/data/obs-plugins/obs-streamlink /E;}"
)